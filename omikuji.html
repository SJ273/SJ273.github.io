<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SJ273のポートフォリオ - おみくじ</title>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
    }
    #text {
       white-space: pre-line;
    }
  </style>
</head>
<body>

<h1>今日のおみくじ</h1>
<button id="btn" onclick="omikuji()">おみくじを引く</button>

<h2><p id="date"></p></h2>
<h1><p id="result"></p></h1>
<p id="comment"></p>

<p id="message"></p>
<p id="notice"></p>

<img id="randomImage" src="">
<p id="text"></p>

<p><a href="/probability">確率を見る</a></p>
<p><a href="/">ホームに戻る</a></p>

<script>
const words = [
  "今日は何が出るかな？",
  "HTMLで色々作るの楽しいですね",
  "寿司が食べたくなってきた",
  "稀に超大吉か超大凶が出るかもしれない\nもし出たら超ラッキーだよ 後者だとしてもね",
  "ここの文字と上のペンギンはランダムで変わるよ",
  "1日1回！"
];

const images = [
  "dan_pen14.gif",
  "mus_pen06.gif",
  "oth_pen18.gif",
  "oth_pen27.gif",
  "oth_pen52.gif",
  "oth_pen54.gif",
  "pen1_76.gif",
  "pen1_23.gif",
  "pen1_42.gif",
  "pen1_50.gif"
];

const comments = {
  "超大吉": ["すげええええええええええ！！！！！！！！！！"],
  "大吉": ["おめでとう！！！！！"],
  "中吉": ["今日は良い日！"],
  "小吉": ["小さなラッキー。"],
  "吉": ["今日はいつも通りが一番。"],
  "末吉": ["これって良いの？悪いの？"],
  "凶": ["ありゃあ………"],
  "大凶": ["トラブルに注意！"],
  "超大凶": ["これはむしろラッキー！"]
};

const todayStr = new Date().toDateString();
let timerId = null;

window.onload = function () {
  showTodayDate();

  document.getElementById("text").textContent =
    words[Math.floor(Math.random() * words.length)];

  document.getElementById("randomImage").src =
    images[Math.floor(Math.random() * images.length)];

  const savedDay = localStorage.getItem("omikujiDay");
  const savedResult = localStorage.getItem("omikujiResult");

  if (savedDay === todayStr && savedResult) {
    showResult(savedResult);
    lockButton();
    startCountdown();
    document.getElementById("notice").textContent =
      "今日はもうおみくじを引いています。";
  }
};

function showTodayDate() {
  const now = new Date();
  document.getElementById("date").textContent =
    `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
}

function omikuji() {
  const r = Math.random() * 100;
  let result = "";

  if (r < 1) result = "超大吉";
  else if (r < 5) result = "大吉";
  else if (r < 20) result = "中吉";
  else if (r < 40) result = "小吉";
  else if (r < 60) result = "吉";
  else if (r < 75) result = "末吉";
  else if (r < 90) result = "凶";
  else if (r < 98) result = "大凶";
  else result = "超大凶";

  localStorage.setItem("omikujiDay", todayStr);
  localStorage.setItem("omikujiResult", result);

  showResult(result);
  lockButton();
  startCountdown();
}

function showResult(result) {
  document.getElementById("result").textContent =
    `${result}`;

  const list = comments[result];
  document.getElementById("comment").textContent =
    list[Math.floor(Math.random() * list.length)];
}

function lockButton() {
  document.getElementById("btn").disabled = true;
}

function getRemainingTimeText() {
  const now = new Date();
  const tomorrow = new Date();
  tomorrow.setHours(24, 0, 0, 0);

  const diff = tomorrow - now;

  if (diff <= 0) {
    clearInterval(timerId);
    localStorage.clear();
    location.reload();
  }

  const h = Math.floor(diff / (1000 * 60 * 60));
  const m = Math.floor((diff / (1000 * 60)) % 60);
  const s = Math.floor((diff / 1000) % 60);

  return `もう一度引けるまで残り${h}時間${m}分${s}秒`;
}

function startCountdown() {
  if (timerId !== null) return;
  timerId = setInterval(() => {
    document.getElementById("message").textContent =
      getRemainingTimeText();
  }, 1000);
}
</script>

</body>
</html>
