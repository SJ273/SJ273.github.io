<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SJ273のポートフォリオ - 避けるゲーム</title>
<link rel="stylesheet" href="style.css">
<style>
body { text-align: center; background: white; font-family: sans-serif; }
#game { width: 320px; height: 480px; margin: auto; border: 2px solid black; position: relative; overflow: hidden; touch-action: none; background-image: url("background.png"); background-size: cover; background-position: center; }
#player { width: 50px; position: absolute; bottom: 10px; left: 135px; pointer-events: none; transition: left 0.05s linear; }
.enemy { width: 40px; position: absolute; pointer-events: none; }
#info { font-size: 18px; margin-top: 10px; }
#overlay, #startScreen { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10; }
.over-text, #startScreen div { color: white; text-align: center; display: flex; flex-direction: column; align-items: center; }
.over-text p, #startScreen p { font-size: 22px; margin-bottom: 10px; }

button {
  font-size: 16px;      
  padding: 8px 16px;     
  border-radius: 5px;
  min-width: auto;       
  flex: 1 1 auto;         
  text-align: center;
}
button.selected { background: orange; color: white; }
button:not(.selected) { background: white; color: black; }

.overlay-difficulty,
.start-difficulty {
  display: flex;
  flex-direction: column;
  gap: 10px;
  justify-content: center;
  align-items: center;
  margin-top: 10px;
}
.currentDifficultyLabel {
  font-size: 14px;
  color: orange;
  display: none;
}

#highScore {
  text-align: center;
  white-space: nowrap;
  display: block;
}
</style>
</head>
<body>
<h1 class="section-title">DODGE GAME</h1>
<div style="height: 1em;"></div>
マウスを動かしてペンギンを操作します。スマホの人はタップで。
<div style="height: 6px;"></div>
落ちてくる岩を避けましょう。当たると即ゲームオーバー。
<div style="height: 6px;"></div>
音が流れるので音量注意。
<div style="height: 1em;"></div>
<div id="game">
  <img id="player" src="pen1_34.gif">

  <div id="overlay" style="display:none;">
    <div class="over-text">
      <p>ゲームオーバー</p>
      <p><span id="highScore">0</span></p>
      <p>難易度を選ぶ：</p>
      <div class="overlay-difficulty">
        <div>
        <button class="difficulty" data-key="easy">簡単</button>
        <span class="currentDifficultyLabel">↑今コレ</span>
        </div>
        <div>
        <button class="difficulty" data-key="normal">普通</button>
        <span class="currentDifficultyLabel">↑今コレ</span>
        </div>
        <div>
        <button class="difficulty" data-key="hard">難しい</button>
        <span class="currentDifficultyLabel">↑今コレ</span>
        </div>
        <div>
        <button class="difficulty" data-key="impossible">絶対無理</button>
        <span class="currentDifficultyLabel">↑今コレ</span>
        </div>
      </div>
  </div>
</div>

  <div id="startScreen">
    <div>
      <p>避けるゲーム</p>
      <p>左右に動いて岩を避けよう！</p>
      <p>難易度を選ぶ：</p>
      <div class="start-difficulty">
        <button class="difficulty" data-key="easy">簡単</button>
        <button class="difficulty" data-key="normal">普通</button>
        <button class="difficulty" data-key="hard">難しい</button>
        <button class="difficulty" data-key="impossible">絶対無理</button>
      </div>
    </div>
  </div>
</div>

<div id="info">
  スコア: <span id="score">0</span>
</div>
<div style="height: 2em;"></div>
「絶対無理」はネタです。
<div style="height: 6px;"></div>
クレームはお控えください。
<div style="height: 2em;"></div>
<a href="/">ホームに戻る</a>
<h1 class="section-title" data-direction="right">DODGE GAME</h1>
<font size="2">2025-2026 SJ273</font>
<div style="height: 2em;"></div>
<script src="marquee.js"></script>
<script>
const game = document.getElementById("game");
const player = document.getElementById("player");
const scoreEl = document.getElementById("score");
const overlay = document.getElementById("overlay");
const highScoreEl = document.getElementById("highScore");
const startScreen = document.getElementById("startScreen");

const preloadImages = [
  "pen1_34.gif",
  "pen1_12.gif",
  "rock.png"
];

preloadImages.forEach(src => {
  const img = new Image();
  img.src = src;
});

const FIXED_DT = 1 / 60;
let accumulator = 0;
let lastTime = 0;
  
let enemies = [];
let speed = 3;
let score = 0;
let gameOver = false;
let bgY = 0;
let gameStarted = false;
let targetX = 135;
let currentDifficulty = "normal";
let maxEnemies = 0;

const difficultyNames = {
  easy: "簡単",
  normal: "普通",
  hard: "難しい",
  impossible: "絶対無理"
};

const difficultySettings = {
  easy:   { speed: 2, enemies: 2, speedMin: 0.6, speedMax: 1.0, accel: 0.02, maxEnemies: 6 },
  normal: { speed: 3, enemies: 3, speedMin: 0.8, speedMax: 1.5, accel: 0.05, maxEnemies: 7 },
  hard:   { speed: 3.5, enemies: 4, speedMin: 1.0, speedMax: 1.6, accel: 0.05, maxEnemies: 8 },
  impossible: { speed: 3, enemies: 8, speedMin: 3, speedMax: 3, accel: 0, maxEnemies: 8 }
};

function loadHighScore() {
  let hs = localStorage.getItem("highScore_" + currentDifficulty);
  return hs ? Number(hs) : 0;
}

let highScore = loadHighScore();

function playSound(src) { new Audio(src).play(); }

function resetEnemy(e) {
  e.dataset.y = -Math.random() * 700 - 40;
  e.style.left = Math.random() * 280 + "px";
  e.style.top = e.dataset.y + "px";
}

function createEnemy() {
  if (enemies.length >= maxEnemies) return;
  const e = document.createElement("img");
  e.src = "rock.png";
  e.className = "enemy";

  const set = difficultySettings[currentDifficulty];
  e.dataset.speed = Math.random() * (set.speedMax - set.speedMin) + set.speedMin;

  resetEnemy(e);
  game.appendChild(e);
  enemies.push(e);
}

function createImpossibleLine() {
  enemies.forEach(e => e.remove());
  enemies = [];
  const rockWidth = 40;
  const cols = Math.floor(game.offsetWidth / rockWidth);
  for (let i = 0; i < cols; i++) {
    const e = document.createElement("img");
    e.src = "rock.png";
    e.className = "enemy";
    e.dataset.speed = 3;
    e.dataset.y = -50;
    e.style.left = i * rockWidth + "px";
    e.style.top = e.dataset.y + "px";
    game.appendChild(e);
    enemies.push(e);
  }
}

game.addEventListener("mousemove", e => {
  const rect = game.getBoundingClientRect();
  targetX = e.clientX - rect.left - player.offsetWidth / 2;
});
game.addEventListener("touchmove", e => {
  const rect = game.getBoundingClientRect();
  targetX = e.touches[0].clientX - rect.left - player.offsetWidth / 2;
});

function hit(a, b) {
  const r1 = a.getBoundingClientRect();
  const r2 = b.getBoundingClientRect();
  const shrink = 0.8;
  const r1Width = r1.width * shrink, r1Height = r1.height * shrink;
  const r1Left = r1.left + (r1.width - r1Width)/2, r1Top = r1.top + (r1.height - r1Height)/2;
  const r2Width = r2.width * shrink, r2Height = r2.height * shrink;
  const r2Left = r2.left + (r2.width - r2Width)/2, r2Top = r2.top + (r2.height - r2Height)/2;
  return r1Left < r2Left + r2Width && r1Left + r1Width > r2Left &&
         r1Top < r2Top + r2Height && r1Top + r1Height > r2Top;
}

function updateHighScoreDisplay() {
  const maxWidth = game.offsetWidth - 10; // 余白
  highScoreEl.style.whiteSpace = "nowrap";
  highScoreEl.style.textAlign = "center";

  let fontSize = 20; 
  highScoreEl.style.fontSize = fontSize + "px";
  highScoreEl.textContent = `あなたのハイスコア（${difficultyNames[currentDifficulty]}）：${highScore}`;

  while(highScoreEl.offsetWidth > maxWidth && fontSize > 10) {
    fontSize -= 1;
    highScoreEl.style.fontSize = fontSize + "px";
  }
}

function endGame() {
  gameOver = true;
  player.src = "pen1_12.gif";
  playSound("打撃4.mp3");

  if (score > highScore) {
    highScore = score;
    localStorage.setItem("highScore_" + currentDifficulty, highScore);
  }

  updateHighScoreDisplay();
  overlay.style.display = "flex";
  updateDifficultyButtons();
}

function loop(timestamp) {
  if (gameOver || !gameStarted) return;

  if (!lastTime) lastTime = timestamp;
  let delta = (timestamp - lastTime) / 1000;
  lastTime = timestamp;

  if (delta > 0.1) delta = 0.1;

  accumulator += delta;

  while (accumulator >= FIXED_DT) {
    fixedUpdate(FIXED_DT);
    accumulator -= FIXED_DT;
  }

  requestAnimationFrame(loop);
}

function fixedUpdate(dt) {
  const rect = game.getBoundingClientRect();
  const set = difficultySettings[currentDifficulty];

  let px = parseFloat(player.style.left) || 0;
  const moveSpeed = 400;
  let dx = targetX - px;
  const step = moveSpeed * dt;

  if (Math.abs(dx) <= step) px = targetX;
  else px += dx > 0 ? step : -step;

  px = Math.max(0, Math.min(rect.width - player.offsetWidth, px));
  player.style.left = px + "px";

  bgY += speed * dt * 60 / 2;
  game.style.backgroundPosition = `0px ${bgY}px`;

  enemies.forEach(e => {
    if (currentDifficulty === "impossible") {
      e.dataset.y = Number(e.dataset.y) + set.speed * dt * 60;
      e.style.top = e.dataset.y + "px";

      if (hit(player, e)) endGame();
      if (e.dataset.y > 480) e.dataset.y = -50;

    } else {
      let y = Number(e.dataset.y);
      y += speed * e.dataset.speed * dt * 60;
      e.dataset.y = y;
      e.style.top = y + "px";

      if (hit(player, e)) endGame();

      if (y > 480) {
        resetEnemy(e);
        score++;
        scoreEl.textContent = score;
        playSound("決定ボタンを押す40.mp3");

        if (score % Math.max(1, 6 - set.enemies) === 0) {
          createEnemy();
        }

        speed += set.accel * dt * 60;
        if (speed > set.speedMax * 1.2) speed = set.speedMax * 1.2;
      }
    }
  });

  if (currentDifficulty !== "impossible") {
    while (enemies.length < set.maxEnemies) {
      createEnemy();
    }
  }
}

function startGame() {
  player.style.left = targetX + "px";
  const set = difficultySettings[currentDifficulty];
  speed = set.speed;
  maxEnemies = set.maxEnemies;

  enemies.forEach(e => e.remove());
  enemies = [];

  if (currentDifficulty === "impossible") {
    createImpossibleLine();
  } else {
    for (let i = 0; i < set.enemies; i++) createEnemy();
  }

  highScore = loadHighScore();
  updateHighScoreDisplay();

  startScreen.style.display = "none";
  overlay.style.display = "none";
  score = 0;
  scoreEl.textContent = score;
  bgY = 0;
  gameOver = false;
  player.src = "pen1_34.gif";
  gameStarted = true;
  lastTime = 0;
  accumulator = 0;
  requestAnimationFrame(loop);
}

const allDifficultyButtons = document.querySelectorAll(".difficulty");

function updateDifficultyButtons() {
  allDifficultyButtons.forEach(btn => {
    const label = btn.nextElementSibling;
    if (btn.dataset.key === currentDifficulty) {
      btn.classList.add("selected");
      if (label) label.style.display = "block";
    } else {
      btn.classList.remove("selected");
      if (label) label.style.display = "none";
    }
  });
  highScore = loadHighScore();
  updateHighScoreDisplay();
}

startScreen.querySelectorAll(".difficulty").forEach(btn => {
  btn.addEventListener("click", () => {
    currentDifficulty = btn.dataset.key;
    updateDifficultyButtons();
    startGame();
  });
});

overlay.querySelectorAll(".difficulty").forEach(btn => {
  btn.addEventListener("click", () => {
    currentDifficulty = btn.dataset.key;
    updateDifficultyButtons();
    startGame();
  });
});
</script>
</body>
</html>
