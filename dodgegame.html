<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SJ273のポートフォリオ - 避けるゲーム</title>
<style>
  body {
    text-align: center;
    background: white;
    font-family: sans-serif;
  }

  #game {
    width: 320px;
    height: 480px;
    margin: auto;
    border: 2px solid black;
    position: relative;
    overflow: hidden;
    touch-action: none;
    background-image: url("background.png");
    background-size: cover;
    background-position: center;
  }

  #player {
    width: 50px;
    position: absolute;
    bottom: 10px;
    left: 135px;
    pointer-events: none;
  }

  .enemy {
    width: 40px;
    position: absolute;
    pointer-events: none;
  }

  #info {
    font-size: 18px;
    margin-top: 10px;
  }

  #overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }

  .over-text {
    color: white;
    text-align: center;
  }

  .over-text p {
    font-size: 22px;
    margin-bottom: 10px;
  }

  .over-text button {
    font-size: 18px;
    padding: 10px 20px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>避けるゲーム</h2>

<div id="game">
  <img id="player" src="pen1_34.gif">

  <div id="overlay">
    <div class="over-text">
      <p>ゲームオーバー</p>
      <p>あなたのハイスコア: <span id="highScore">0</span></p>
      <button id="retry">もう一度</button>
    </div>
  </div>
</div>

<div id="info">
  スコア: <span id="score">0</span>
</div>

<script>

const game = document.getElementById("game");
const player = document.getElementById("player");
const scoreEl = document.getElementById("score");
const overlay = document.getElementById("overlay");
const retryBtn = document.getElementById("retry");
const highScoreEl = document.getElementById("highScore");

let enemies = [];
let speed = 3;
let score = 0;
let gameOver = false;
let bgY = 0;

let highScore = localStorage.getItem("highScore") || 0;
highScoreEl.textContent = highScore;

const gameOverSound = new Audio("打撃4.mp3");
const pointSound = new Audio("決定ボタンを押す40.mp3");

let targetX = 135;

function resetEnemy(e) {
  e.dataset.y = -Math.random() * 700 - 40;
  e.style.left = Math.random() * 280 + "px";
  e.style.top = e.dataset.y + "px";
}

function createEnemy() {
  const e = document.createElement("img");
  e.src = "rock.png";
  e.className = "enemy";
  e.dataset.speed = Math.random() * 1.5 + 0.8;
  resetEnemy(e);
  game.appendChild(e);
  enemies.push(e);
}

for (let i = 0; i < 3; i++) createEnemy();

game.addEventListener("mousemove", e => {
  const rect = game.getBoundingClientRect();
  targetX = e.clientX - rect.left - player.offsetWidth / 2;
});
game.addEventListener("touchmove", e => {
  const rect = game.getBoundingClientRect();
  targetX = e.touches[0].clientX - rect.left - player.offsetWidth / 2;
});

function hit(a, b) {
  const r1 = a.getBoundingClientRect();
  const r2 = b.getBoundingClientRect();
  const shrink = 0.8;

  const r1Width = r1.width * shrink;
  const r1Height = r1.height * shrink;
  const r1Left = r1.left + (r1.width - r1Width) / 2;
  const r1Top = r1.top + (r1.height - r1Height) / 2;

  const r2Width = r2.width * shrink;
  const r2Height = r2.height * shrink;
  const r2Left = r2.left + (r2.width - r2Width) / 2;
  const r2Top = r2.top + (r2.height - r2Height) / 2;

  return (
    r1Left < r2Left + r2Width &&
    r1Left + r1Width > r2Left &&
    r1Top < r2Top + r2Height &&
    r1Top + r1Height > r2Top
  );
}

function endGame() {
  gameOver = true;

  player.src = "pen_12.gif";

  gameOverSound.play();

  if (score > highScore) {
    highScore = score;
    localStorage.setItem("highScore", highScore);
  }
  highScoreEl.textContent = highScore;
  overlay.style.display = "flex";
}

function loop() {
  if (gameOver) return;

  let px = parseFloat(player.style.left) || 0;
  px += (targetX - px) * 0.2;
  const rect = game.getBoundingClientRect();
  px = Math.max(0, Math.min(rect.width - player.offsetWidth, px));
  player.style.left = px + "px";

  bgY += speed / 2;
  game.style.backgroundPosition = `0px ${bgY}px`;

  enemies.forEach(e => {
    let y = Number(e.dataset.y);
    y += speed * e.dataset.speed;
    e.dataset.y = y;
    e.style.top = y + "px";

    if (hit(player, e)) {
      endGame();
      return;
    }

    if (y > 480) {
      resetEnemy(e);
      score++;
      scoreEl.textContent = score;
      pointSound.play();
      if (score % 5 === 0) speed += 0.5;
    }
  });

  requestAnimationFrame(loop);
}

retryBtn.addEventListener("click", () => {
  score = 0;
  speed = 3;
  bgY = 0;
  gameOver = false;
  scoreEl.textContent = score;

  player.src = "pen1_34.gif";

  enemies.forEach(e => resetEnemy(e));
  overlay.style.display = "none";
  loop();
});

loop();
</script>

</body>
</html>
